<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="/WEB-INF/templates/layout.xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core">
    <ui:define name="content">

        <script type="text/javascript">
            function initDND() {
                $('.ui-treenode-leaf').draggable({
                    helper: 'clone',
                    scope: 'treetotable',
                    zIndex: ++PrimeFaces.zindex
                });

                $('.ui-datatable .droppoint').droppable({
                    activeClass: 'ui-state-active',
                    hoverClass: 'ui-state-highlight',
                    tolerance: 'pointer',
                    scope: 'treetotable',
                    drop: function (event, ui) {
                        var property = ui.draggable.find('.ui-treenode-label').text(),
                                droppedColumnId = $(this).parents('th:first').attr('id'),
                                dropPos = $(this).hasClass('dropleft') ? 0 : 1;

                        treeToTable([
                            {name: 'property', value: property}
                            , {name: 'droppedColumnId', value: droppedColumnId}
                            , {name: 'dropPos', value: dropPos}
                        ]);
                    }
                });

                $('.ui-datatable th').draggable({
                    scope: 'tabletotree',
                    helper: function () {
                        var th = $(this);

                        return th.clone().appendTo(document.body).css('width', th.width());
                    }
                });

                $('.ui-tree').droppable({
                    helper: 'clone',
                    scope: 'tabletotree',
                    activeClass: 'ui-state-active',
                    hoverClass: 'ui-state-highlight',
                    tolerance: 'touch',
                    drop: function (event, ui) {
                        tableToTree([
                            {name: 'colIndex', value: ui.draggable.index()}
                        ]);
                    }
                });
            }

            $(function () {
                initDND();
            });
        </script>

        <ui:param name="bean" value="#{privilegioListBean}" />
        <h:form id="frm">
            <p:remoteCommand name="treeToTable" actionListener="#{privilegioListBean.treeToTable}" update="tree lst" oncomplete="initDND()"/>
            <p:remoteCommand name="tableToTree" actionListener="#{privilegioListBean.tableToTree}" update="tree lst" oncomplete="initDND()"/>


            <p:panel header="GestiÃ³n de Privilegios">

                <p:tree id="tree" value="#{privilegioListBean.recursos}" var="column" style="margin-bottom:20px">
                    <p:treeNode>
                        <h:outputText value="#{column}" />
                    </p:treeNode>

                    <p:treeNode type="column" icon="ui-icon-grip-dotted-vertical">
                        <h:outputText value="#{column.descripcion}" />
                    </p:treeNode>
                </p:tree>

                <!-- listado -->
                <br />
                <p:dataTable id="lst" var="rol" value="#{bean.roles}" selectionMode="single" selection="#{bean.rolSelected}" rowKey="#{rol.idRol}">
                    <p:ajax event="rowSelect" update="frm:lstPrivilegios" />
                    <p:column headerText="Nombre">
                        <p:outputLabel value="#{rol.nombre}" />
                    </p:column>
                    <p:column headerText="Descripcion">
                        <p:outputLabel value="#{rol.descripcion}" />
                    </p:column>
                    <p:column headerText="+" style="width: 30px">
                        <h:outputText style="float:left;display:block;height:20px;width:10px;border:0 none;" styleClass="droppoint dropleft" /> 
                        +
                        <h:outputText  style="float:right;display:block;height:20px;width:10px;border:0 none;" styleClass="droppoint dropright" />
                    </p:column>
                </p:dataTable>
                <p:dataTable id="lstPrivilegios" var="privilegio" value="#{bean.rolSelected.privilegioList}" editable="true" >
                    <f:facet name="header">
                        Privilegios del rol: #{bean.rolSelected.nombre}
                    </f:facet>
                    <p:column headerText="Nombre">
                        <p:outputLabel value="#{privilegio.recurso.descripcion}" />
                    </p:column>
                    <p:column headerText="Insertar">
                        <p:cellEditor>
                            <f:facet name="output">
                                <h:outputText value="#{privilegio.insertar?'Si':'No'}" />
                            </f:facet>
                            <f:facet name="input">
                                <p:selectBooleanCheckbox value="#{privilegio.insertar}" />
                            </f:facet>
                        </p:cellEditor>
                    </p:column>
                    <p:column headerText="Editar">
                        <p:cellEditor>
                            <f:facet name="output">
                                <h:outputText value="#{privilegio.editar?'Si':'No'}" />
                            </f:facet>
                            <f:facet name="input">
                                <p:selectBooleanCheckbox value="#{privilegio.editar}" />
                            </f:facet>
                        </p:cellEditor>
                    </p:column>
                    <p:column headerText="Eliminar">
                        <p:cellEditor>
                            <f:facet name="output">
                                <h:outputText value="#{privilegio.eliminar?'Si':'No'}" />
                            </f:facet>
                            <f:facet name="input">
                                <p:selectBooleanCheckbox value="#{privilegio.eliminar}" />
                            </f:facet>
                        </p:cellEditor>
                    </p:column>
                    <p:column style="width:32px">
                        <p:rowEditor />
                    </p:column>
                </p:dataTable>
            </p:panel>
            <!--Cuadro de dialogo de confirmacion de eliminacion -->
            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                <p:commandButton value="Si" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
            </p:confirmDialog>

        </h:form>
    </ui:define>

</ui:composition>
